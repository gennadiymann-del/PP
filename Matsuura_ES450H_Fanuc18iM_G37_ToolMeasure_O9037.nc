%
O9037 (G37 TOOL LENGTH MEASURE - MATSUURA ES450H / FANUC 18i-M)
(--- НАЗНАЧЕНИЕ ---)
(Макрос замера длины инструмента по датчику (tool setter) через G31.)
(Результат пишется в геометрию длины H = номер инструмента в шпинделе (#4120).)
(
  ВАЖНО:
  1) Привязка G37 -> O9037 делается параметрами FANUC (обычно 6050/6051).
     Пример: 6050=37, 6051=9037  => вызов G37 запускает O9037.
  2) Макрос использует машинные координаты (G53). Датчик должен быть настроен,
     а вход skip (G31) должен срабатывать от касания датчика.
  3) Перед первым запуском заполните постоянные макро‑переменные #500..#506.
)
(
--- НАСТРОЙКИ (ПРОПИСАТЬ В ПАМЯТИ СТОЙКИ) ---
 #500 = X позиции датчика в G53 (маш. координаты)
 #501 = Y позиции датчика в G53 (маш. координаты)
 #502 = Z поверхности касания датчика в G53 (маш. координаты)
 #503 = Z безопасная в G53 (маш. координаты)
 #504 = Z подвод над датчиком в G53 (маш. координаты)
 #505 = Подача G31 (мм/мин)
 #506 = Перебег вниз (мм) после ожидаемого касания (страховка)
)
(
--- ПРИМЕР ИНИЦИАЛИЗАЦИИ (в MDI один раз, значения ВАШИ!) ---
 #500=...
 #501=...
 #502=...
 #503=...
 #504=...
 #505=100.
 #506=5.
)
(
--- ПРИМЕР ВЫЗОВА ---
 G37
)
(
--- ЗАМЕЧАНИЯ ПО ПЕРЕМЕННЫМ FANUC ---
 #4120  - текущий инструмент в шпинделе (T)
 #5063  - Z координата последнего срабатывания skip (после G31)
 #[2000+H] - геометрия длины (H1 => #2001, H2 => #2002, ...)
 #[2200+H] - износ длины (не трогаем)
)
;
; -------------------- ПРОВЕРКИ --------------------
;
IF [#503 EQ 0] THEN #3000=100 (G37: SET #503 SAFE Z (G53))
IF [#504 EQ 0] THEN #3000=101 (G37: SET #504 APPROACH Z (G53))
IF [#505 LE 0] THEN #3000=102 (G37: SET #505 G31 FEED)
IF [#506 LE 0] THEN #3000=103 (G37: SET #506 OVERTRAVEL)
;
; -------------------- ПОДГОТОВКА --------------------
;
G90 G80 G40
G49
M5
M9
;
; -------------------- ПЕРЕХОД К ДАТЧИКУ (G53) --------------------
;
G53 G0 Z[#503]
G53 G0 X[#500] Y[#501]
G53 G0 Z[#504]
;
; -------------------- ЗАМЕР (G31) --------------------
;
; Страховочная глубина: уходим чуть ниже ожидаемого касания
; (если skip не сработает, дойдем до цели и уйдем в ALARM ниже).
#100 = [#502 - ABS[#506]]  ; целевой Z в G53 ниже поверхности датчика
G53 G31 Z[#100] F[#505]
;
; Проверка: если skip не сработал, то #5063 окажется близко к целевому #100
IF [ABS[#5063 - #100] LT 0.001] THEN #3000=110 (G37: NO SKIP SIGNAL)
;
; -------------------- РАСЧЕТ ДЛИНЫ И ЗАПИСЬ В H --------------------
;
#101 = FIX[#4120]          ; номер инструмента в шпинделе
IF [#101 LT 1] THEN #3000=120 (G37: BAD TOOL NUMBER)
IF [#101 GT 400] THEN #3000=121 (G37: TOOL# TOO LARGE)
;
; Длина инструмента = Z_касанья(позиция линии калибра в G53) - Z_поверхности датчика
#102 = [#5063 - #502]
;
; Запись в геометрию длины: H = T
#[2000 + #101] = #102
;
; Сообщение оператору (без остановки программы)
#3006 = 1 (G37 DONE: H=T UPDATED)
;
; -------------------- ОТХОД --------------------
;
G53 G0 Z[#503]
M99
%
