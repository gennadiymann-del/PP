%
O9999 (TOOL MEASUREMENT - UPDATED MACRO-B, MATSUURA ES450H / FANUC 18i-M)
(Основано на вашем O9999, но исправлен цикл G31 и расчёт координат.)
(
  ЛОГИКА:
  - Переезд к датчику (X/Y) и безопасный Z (в G53).
  - Подвод в Z по сохранённому значению #[11000+T] (если есть).
  - Быстрый G31 вниз (поиск касания).
  - Отъезд вверх.
  - Медленный G31 вниз (точное касание).
  - Запись результата в #[11000+T] = (Ztouch_machine - Zsensor_machine).
  - (Опционально) запись в геометрию длины H через G10 или #[2000+H].
)
(
  НАСТРОЙКИ (проверьте под ваш станок):
  #100 = Z датчика в МАШИННЫХ координатах (G53)
  X/Y датчика: #101/#102 (если 0 — используются значения по умолчанию)
  #103 = SAFE_Z в G53 (обычно 0)
  #104 = Быстрый ход подводом (мм/мин)
  #105 = Быстрый G31 (мм/мин)
  #106 = Медленный G31 (мм/мин)
  #107 = Подъём между касаниями (мм)
  #108 = Ход быстрого поиска (мм)
  #109 = Ход медленного поиска (мм)
  #110 = CLEARANCE (мм) над ожидаемой точкой касания при подводе
  #111 = 0/1: писать геометрию длины через G10 L10 (1 = да)
  #112 = 0/1: писать геометрию длины через #[2000+H] (1 = да)
)

; -------------------- НАСТРОЙКА ПО УМОЛЧАНИЮ --------------------
#100 = -287.344 (Machine Z sensor)

IF [#101 EQ 0] THEN #101 = -11.0     (TS X G53)
IF [#102 EQ 0] THEN #102 = -389.5    (TS Y G53)
IF [#103 EQ 0] THEN #103 = 0.0       (SAFE Z G53)

IF [#104 LE 0] THEN #104 = 3000.     (Approach feed)
IF [#105 LE 0] THEN #105 = 1000.     (Fast probe feed)
IF [#106 LE 0] THEN #106 = 200.      (Slow probe feed)
IF [#107 LE 0] THEN #107 = 2.0       (Retract between probes)
IF [#108 LE 0] THEN #108 = 80.0      (Fast probe distance)
IF [#109 LE 0] THEN #109 = 10.0      (Slow probe distance)
IF [#110 LE 0] THEN #110 = 100.0     (Clearance above expected touch)

IF [#111 NE 1] THEN #111 = 0
IF [#112 NE 1] THEN #112 = 0

; -------------------- ПОДГОТОВКА --------------------
G90 G94 G17 G49 G40 G80
G21
G91 G28 Z0
G91 G28 X0 Y0
G90
M34
M82
M86

; -------------------- ПРОВЕРКИ --------------------
IF [#4120 EQ 0] GOTO 200

; -------------------- ПЕРЕХОД К ДАТЧИКУ --------------------
G53 G00 Z[#103]
G53 G00 X[#101] Y[#102]

; -------------------- ПРЕДПОДВОД В Z --------------------
; Используем сохранённое значение #[11000+T] (у вас оно отрицательное),
; чтобы подойти ближе к датчику и не делать лишний холостой ход.
; Если для данного T ещё нет значения, подводим “грубо” по CLEARANCE.
#120 = #[11000 + #4120]
IF [#120 EQ 0] THEN #120 = -200.     (Fallback, если инструмент ещё не меряли)

; Целевая позиция шпинделя (маш. Z) перед G31: Zsensor + сохранённое + clearance
; (при отрицательном #120 получится движение вниз)
#121 = [#100 + #120 + ABS[#110]]

; ВАЖНО: идём именно в G53, абсолютом
G53 G00 Z[#103]
G53 G01 Z[#121] F[#104]

; -------------------- ПРОБА 1 (БЫСТРО) --------------------
; Идём вниз на #108 мм инкрементально в машинных координатах
G53 G31 Z[#121 - ABS[#108]] F[#105]

; Проверка “не было касания”: если дошли точно до цели — skip не сработал
IF [ABS[#5043 - [#121 - ABS[#108]]] LT 0.001] THEN #3000=110 (NO SKIP SIGNAL - FAST)

; Отъезд вверх перед точной пробой
G53 G00 Z[#5043 + ABS[#107]]

; -------------------- ПРОБА 2 (МЕДЛЕННО) --------------------
G53 G31 Z[#5043 - ABS[#109]] F[#106]

IF [ABS[#5043 - [#5043 - ABS[#109]]] LT 0.001] THEN #3000=111 (NO SKIP SIGNAL - SLOW)

; -------------------- РАСЧЁТ И ЗАПИСЬ --------------------
; На Fanuc #5043 = текущая машинная координата Z (после остановки G31).
; Значение сохраняем как “Ztouch - Zsensor” (как в вашем макросе).
#130 = [#5043 - #100]
#[11000 + #4120] = #130

; Опционально: записать в таблицу геометрии длины H=T
IF [#111 EQ 1] THEN G10 L10 P#4120 R[#130]
IF [#112 EQ 1] THEN #[2000 + #4120] = #130

#3006 = 1 (TOOL MEASURE DONE)

; -------------------- ВОЗВРАТ --------------------
G91 G28 Z0.
M87
M35
G91 G28 X0. Y0.
M30

N200
#3000=1 (TOOL NUMBER ZERO. PLEASE TOOL CALL T# M6)
M30
%
